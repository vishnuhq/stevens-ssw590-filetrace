# FileTrace CI/CD Pipeline - GitHub Actions
# Triggers on push to main branch and pull requests
# PR: Tests + Security only (no secrets needed - uses mocks)
# Merge to main: Full pipeline with deployment
#
# ============================================
# CI/CD DISABLED - AWS free tier credits expired
# Infrastructure has been decommissioned as of December 2025
# To re-enable: remove 'if: false' from all jobs below
# ============================================

name: FileTrace CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: filetrace-backend
  NODE_VERSION: '24'

# Minimum permissions for security
permissions:
  contents: read
  pull-requests: read

jobs:
  # ============================================
  # Job 1: Install Dependencies
  # ============================================
  install:
    if: false # CI/CD disabled - AWS infrastructure decommissioned
    name: Install Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache backend dependencies
        uses: actions/cache@v4
        id: cache-backend
        with:
          path: server/node_modules
          key: ${{ runner.os }}-backend-${{ hashFiles('server/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-backend-

      - name: Cache frontend dependencies
        uses: actions/cache@v4
        id: cache-frontend
        with:
          path: client/node_modules
          key: ${{ runner.os }}-frontend-${{ hashFiles('client/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-

      - name: Install backend dependencies
        if: steps.cache-backend.outputs.cache-hit != 'true'
        run: cd server && npm ci

      - name: Install frontend dependencies
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        run: cd client && npm ci

  # ============================================
  # Job 2: Lint Code
  # ============================================
  lint:
    if: false # CI/CD disabled - AWS infrastructure decommissioned
    name: Lint Code
    runs-on: ubuntu-latest
    needs: install

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore backend cache
        uses: actions/cache@v4
        with:
          path: server/node_modules
          key: ${{ runner.os }}-backend-${{ hashFiles('server/package-lock.json') }}

      - name: Install dependencies (if cache miss)
        run: |
          if [ ! -d "server/node_modules" ]; then
            cd server && npm ci
          fi

      - name: Run ESLint
        run: |
          cd server
          npm run lint --if-present || echo "No lint script found, skipping"

  # ============================================
  # Job 3: Run Tests
  # Tests use mocked services (no secrets needed)
  # ============================================
  test:
    if: false # CI/CD disabled - AWS infrastructure decommissioned
    name: Run Tests
    runs-on: ubuntu-latest
    needs: install

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore backend cache
        uses: actions/cache@v4
        with:
          path: server/node_modules
          key: ${{ runner.os }}-backend-${{ hashFiles('server/package-lock.json') }}

      - name: Install dependencies (if cache miss)
        run: |
          if [ ! -d "server/node_modules" ]; then
            cd server && npm ci
          fi

      - name: Run backend tests with coverage
        run: |
          cd server
          npm run test:coverage
        env:
          # CI=true triggers MongoDB Memory Server and mocked S3
          # No real secrets needed - tests are fully isolated
          CI: 'true'
          NODE_ENV: test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./server/coverage/coverage-final.json
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: server/coverage/
          retention-days: 7

  # ============================================
  # Job 4: Security Scan (no secrets needed)
  # ============================================
  security:
    if: false # CI/CD disabled - AWS infrastructure decommissioned
    name: Security Scan
    runs-on: ubuntu-latest
    needs: install

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore backend cache
        uses: actions/cache@v4
        with:
          path: server/node_modules
          key: ${{ runner.os }}-backend-${{ hashFiles('server/package-lock.json') }}

      - name: Install dependencies (if cache miss)
        run: |
          if [ ! -d "server/node_modules" ]; then
            cd server && npm ci
          fi

      - name: Run npm audit (STRICT - blocks on HIGH/CRITICAL)
        run: |
          cd server
          npm audit --audit-level=high
        # vulnerabilities MUST be fixed

      - name: Run Trivy vulnerability scanner (STRICT - blocks on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './server'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
        # exit-code 1 means pipeline FAILS if vulnerabilities found

      - name: Run Trivy secret scanner (STRICT - blocks on findings)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './server'
          scanners: 'secret'
          format: 'table'
          exit-code: '1'
        # exit-code 1 means pipeline FAILS if secrets found

  # ============================================
  # Job 5: Build Docker Image
  # ONLY ON MERGE TO MAIN (Requires secrets)
  # ============================================
  build:
    if: false # CI/CD disabled - AWS infrastructure decommissioned
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, security, lint]
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    outputs:
      image-tag: ${{ steps.build-image.outputs.image-tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push Docker image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Build image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest

          # Scan image with Trivy (STRICT - blocks on HIGH/CRITICAL vulnerabilities and secrets)
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image --exit-code 1 --severity HIGH,CRITICAL \
            --scanners vuln,secret \
            $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          # No || true - image MUST pass security scan before push

          # Push images
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

  # ============================================
  # Job 6: Deploy Backend to EC2
  # ONLY ON MERGE TO MAIN
  # ============================================
  deploy-backend:
    if: false # CI/CD disabled - AWS infrastructure decommissioned
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest
    needs: build
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get ECR login
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ needs.build.outputs.image-tag }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: ECR_REGISTRY,ECR_REPOSITORY,IMAGE_TAG
          script: |
            # Login to ECR
            aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $ECR_REGISTRY

            # Stop and remove old container
            docker stop filetrace-backend 2>/dev/null || true
            docker rm filetrace-backend 2>/dev/null || true

            # Pull new image
            docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

            # Run new container
            docker run -d \
              --name filetrace-backend \
              --restart unless-stopped \
              -p 3001:3001 \
              -e NODE_ENV=production \
              -e PORT=3001 \
              -e MONGODB_URI="${{ secrets.MONGODB_URI }}" \
              -e DB_NAME=filetrace \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              -e AWS_REGION=us-east-1 \
              -e S3_BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}" \
              -e CLIENT_URL="${{ secrets.CLIENT_URL }}" \
              $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

            # Clean up old images
            docker image prune -af

            # Wait for container to start
            sleep 10

            # Check container is running
            docker ps | grep filetrace-backend

  # ============================================
  # Job 7: Deploy Frontend to S3
  # ONLY ON MERGE TO MAIN
  # ============================================
  deploy-frontend:
    if: false # CI/CD disabled - AWS infrastructure decommissioned
    name: Deploy Frontend to S3
    runs-on: ubuntu-latest
    needs: deploy-backend
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore frontend cache
        uses: actions/cache@v4
        with:
          path: client/node_modules
          key: ${{ runner.os }}-frontend-${{ hashFiles('client/package-lock.json') }}

      - name: Install dependencies (if cache miss)
        run: |
          if [ ! -d "client/node_modules" ]; then
            cd client && npm ci
          fi

      - name: Build frontend
        env:
          VITE_API_URL: ${{ secrets.API_URL }}
        run: |
          cd client
          npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: |
          aws s3 sync client/dist/ s3://${{ secrets.S3_FRONTEND_BUCKET }} --delete

      - name: Invalidate CloudFront cache (optional)
        run: |
          if [ -n "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            aws cloudfront create-invalidation \
              --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
              --paths "/*"
          fi
        continue-on-error: true

  # ============================================
  # Job 8: Health Check
  # ONLY ON MERGE TO MAIN
  # ============================================
  health-check:
    if: false # CI/CD disabled - AWS infrastructure decommissioned
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Wait for services to stabilize
        run: sleep 30

      - name: Check backend health
        run: |
          echo "Checking backend health at http://${{ secrets.EC2_HOST }}:3001/health"
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}:3001/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "Backend is healthy (HTTP 200)"
            curl -s http://${{ secrets.EC2_HOST }}:3001/health | head -c 500
          else
            echo "Backend health check failed with status: $response"
            exit 1
          fi

      - name: Check frontend availability
        run: |
          FRONTEND_URL="http://${{ secrets.S3_FRONTEND_BUCKET }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
          echo "Checking frontend at $FRONTEND_URL"
          response=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || echo "000")
          if [ "$response" = "200" ] || [ "$response" = "304" ]; then
            echo "Frontend is available (HTTP $response)"
          else
            echo "Frontend check failed with status: $response"
            exit 1
          fi

  # ============================================
  # Job 9: Deployment Summary
  # ONLY ON MERGE TO MAIN
  # ============================================
  summary:
    if: false # CI/CD disabled - AWS infrastructure decommissioned
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs:
      [
        test,
        security,
        lint,
        build,
        deploy-backend,
        deploy-frontend,
        health-check,
      ]
    # if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Create deployment summary
        run: |
          echo "## FileTrace Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'Passed' || needs.lint.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.build.result == 'success' && 'Passed' || needs.build.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Deploy | ${{ needs.deploy-backend.result == 'success' && 'Deployed' || needs.deploy-backend.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Deploy | ${{ needs.deploy-frontend.result == 'success' && 'Deployed' || needs.deploy-frontend.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.health-check.result == 'success' && 'Healthy' || needs.health-check.result == 'skipped' && 'Skipped' || 'Unhealthy' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend API:** http://${{ secrets.EC2_HOST }}:3001" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** http://${{ secrets.S3_FRONTEND_BUCKET }}.s3-website-us-east-1.amazonaws.com" >> $GITHUB_STEP_SUMMARY

# ============================================
# Pipeline Summary
# ============================================
#
# PULL REQUESTS (from any source):
#   - install -> lint, test, security (parallel)
#   - NO secrets needed - tests use MongoDB Memory Server + mocked S3
#   - Fork PRs work because no real AWS/MongoDB needed
#
# MERGE TO MAIN:
#   - install -> lint, test, security -> build -> deploy-backend -> deploy-frontend -> health-check -> summary
#   - Requires all secrets configured
#
# Required GitHub Secrets (Settings > Secrets and variables > Actions):
#
# AWS_ACCESS_KEY_ID      - AWS IAM user access key
# AWS_SECRET_ACCESS_KEY  - AWS IAM user secret key
# MONGODB_URI            - MongoDB Atlas connection string
# JWT_SECRET             - JWT signing key
# S3_BUCKET_NAME         - File storage bucket name
# S3_FRONTEND_BUCKET     - Frontend hosting bucket name
# EC2_HOST               - EC2 public IP address
# EC2_USER               - EC2 username (ubuntu)
# EC2_SSH_KEY            - SSH private key content
# CLIENT_URL             - Frontend URL for CORS
# API_URL                - Backend URL for frontend build
# CLOUDFRONT_DISTRIBUTION_ID - Optional CloudFront distribution
# ============================================
